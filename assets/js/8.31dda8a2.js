(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{365:function(a,s,t){"use strict";t.r(s);var e=t(43),n=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"canary-releases"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#canary-releases","aria-hidden":"true"}},[a._v("#")]),a._v(" Canary Releases")]),a._v(" "),t("p",[a._v("To experiment with progressive delivery, you'll be using a small Go application called\n"),t("a",{attrs:{href:"https://github.com/stefanprodan/podinfo",target:"_blank",rel:"noopener noreferrer"}},[a._v("podinfo"),t("OutboundLink")],1),a._v(".\nThe demo app is exposed outside the cluster with App Mesh Gateway.\nThe communication between the ingress and podinfo is managed by Flagger and App Mesh.")]),a._v(" "),t("p",[a._v("For apps running on App Mesh, you can configure Flagger with a Kubernetes custom resource\nto automate the conformance testing, analysis and promotion of a canary release.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/gitops-appmesh-stack.png",alt:"App Mesh Canary Release"}})]),a._v(" "),t("h2",{attrs:{id:"application-bootstrap"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#application-bootstrap","aria-hidden":"true"}},[a._v("#")]),a._v(" Application bootstrap")]),a._v(" "),t("p",[a._v("The application manifests are comprised of a Kubernetes deployment, a horizontal pod autoscaler,\na gateway route (AppMesh custom resource) and release polices (Flagger custom resources).")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("./apps/podinfo/\n├── abtest.yaml\n├── canary.yaml\n├── deployment.yaml\n├── gateway-route.yaml\n├── hpa.yaml\n└── kustomization.yaml\n")])])]),t("p",[a._v("Wait for Flagger to initialize the canary:")]),a._v(" "),t("div",{staticClass:"language-console extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("$ watch kubectl -n apps get canary\nNAME      STATUS      WEIGHT   LASTTRANSITIONTIME\npodinfo   Initialized 0        2020-11-14T12:03:39Z\n")])])]),t("p",[a._v("Find the AppMesh Gateway public address with:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("URL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"http://'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("kubectl -n appmesh-gateway get svc/appmesh-gateway -o "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("jsonpath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'{.status.loadBalancer.ingress[0].hostname}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$URL")]),a._v("\n")])])]),t("p",[a._v("Wait for the DNS to propagate and podinfo to become accessible:")]),a._v(" "),t("div",{staticClass:"language-console extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('$ watch curl -s ${URL}\n{\n  "hostname": "podinfo-primary-5cf44b9799-lgq79",\n  "version": "5.0.0"\n}\n')])])]),t("p",[a._v("When the URL becomes available, open it in a browser and you'll see the podinfo UI.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/podinfo-500.png",alt:"podinfo"}})]),a._v(" "),t("h2",{attrs:{id:"automated-canary-promotion"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#automated-canary-promotion","aria-hidden":"true"}},[a._v("#")]),a._v(" Automated canary promotion")]),a._v(" "),t("p",[a._v("When you deploy a new podinfo version, Flagger gradually shifts traffic to the canary,\nand at the same time, measures the requests success rate as well as the average response duration.\nBased on an analysis of these App Mesh provided metrics, a canary deployment is either promoted or rolled back.")]),a._v(" "),t("p",[a._v("Pull the changes from GitHub:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" pull origin main\n")])])]),t("p",[a._v("The canary analysis is defined in "),t("code",[a._v("./apps/podinfo/canary.yaml")]),a._v(":")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[a._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max traffic percentage routed to canary")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("maxWeight")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# canary increment step")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stepWeight")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# time to wait between traffic increments")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 15s\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max number of failed metric checks before rollback")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("threshold")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# AppMesh Prometheus checks")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metrics")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("success"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rate\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# minimum req success rate percentage (non 5xx)")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("thresholdRange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("min")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("99")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("duration\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# maximum req duration in milliseconds")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("thresholdRange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("max")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("500")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n")])])]),t("p",[a._v("Bump podinfo version from "),t("code",[a._v("5.0.0")]),a._v(" to "),t("code",[a._v("5.0.1")]),a._v(":")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("yq e "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'.images[0].newTag=\"5.0.1\"'")]),a._v(" -i ./apps/podinfo/kustomization.yaml\n")])])]),t("p",[a._v("Commit and push changes:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" -A "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" commit -m "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"podinfo 5.0.1"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" push origin main\n")])])]),t("p",[a._v("Tell Flux to pull the changes or wait one minute for Flux to detect the changes:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("flux reconcile "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("source")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" flux-system\n")])])]),t("p",[a._v("Wait for the cluster reconciliation to finish:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" flux get kustomizations\n")])])]),t("p",[a._v("When Flagger detects that the deployment revision changed, it will start a new rollout.\nYou can monitor the traffic shifting with:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" kubectl -n apps get canary\n")])])]),t("p",[a._v("Watch Flagger logs:")]),a._v(" "),t("div",{staticClass:"language-console extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("$ kubectl -n appmesh-system logs deployment/flagger -f | jq .msg\nNew revision detected! Scaling up podinfo.apps\nStarting canary analysis for podinfo.apps\nPre-rollout check acceptance-test passed\nAdvance podinfo.apps canary weight 5\nAdvance podinfo.apps canary weight 10\nAdvance podinfo.apps canary weight 15\nAdvance podinfo.apps canary weight 20\nAdvance podinfo.apps canary weight 25\nAdvance podinfo.apps canary weight 30\nAdvance podinfo.apps canary weight 35\nAdvance podinfo.apps canary weight 40\nAdvance podinfo.apps canary weight 45\nAdvance podinfo.apps canary weight 50\nCopying podinfo.apps template spec to podinfo-primary.apps\nRouting all traffic to primary\nPromotion completed! Scaling down podinfo.apps\n")])])]),t("p",[a._v("Lastly, open up podinfo in the browser. You'll see that as Flagger shifts more traffic\nto the canary according to the policy in the Canary object,\nwe see requests going to our new version of the app.")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$URL")]),a._v("\n")])])]),t("h2",{attrs:{id:"a-b-testing"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#a-b-testing","aria-hidden":"true"}},[a._v("#")]),a._v(" A/B Testing")]),a._v(" "),t("p",[a._v("Besides weighted routing, Flagger can be configured to route traffic to the canary based on HTTP match conditions.\nIn an A/B testing scenario, you'll be using HTTP headers or cookies to target a certain segment of your users.\nThis is particularly useful for frontend applications that require session affinity.")]),a._v(" "),t("p",[a._v("Enable A/B testing:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("yq e "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'.resources[0]=\"abtest.yaml\"'")]),a._v(" -i ./apps/podinfo/kustomization.yaml\n")])])]),t("p",[a._v("The above configuration will run a canary analysis targeting users based on their browser user-agent.")]),a._v(" "),t("p",[a._v("The A/B test routing is defined in "),t("code",[a._v("./apps/podinfo/abtest.yaml")]),a._v(":")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[a._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# number of iterations")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("iterations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# time to wait between iterations")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 15s\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max number of failed metric checks before rollback")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("threshold")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# user segmentation")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("headers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("user-agent")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('".*(Firefox|curl).*"')]),a._v("\n")])])]),t("p",[a._v("Bump podinfo version to "),t("code",[a._v("5.0.2")]),a._v(":")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("yq e "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'.images[0].newTag=\"5.0.2\"'")]),a._v(" -i ./apps/podinfo/kustomization.yaml\n")])])]),t("p",[a._v("Commit and push changes:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" -A "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" commit -m "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"podinfo 5.0.2"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" push origin main\n")])])]),t("p",[a._v("Tell Flux to pull changes:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("flux reconcile "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("source")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" flux-system\n")])])]),t("p",[a._v("Wait for Flagger to start the A/B test:")]),a._v(" "),t("div",{staticClass:"language-console extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("$ kubectl -n appmesh-system logs deploy/flagger -f | jq .msg\nNew revision detected! Scaling up podinfo.apps\nStarting canary analysis for podinfo.apps\nPre-rollout check acceptance-test passed\nAdvance podinfo.apps canary iteration 1/10\n")])])]),t("p",[a._v("Open the podinfo URL in Firefox and you will be routed to version "),t("code",[a._v("5.0.2")]),a._v(" or use curl:")]),a._v(" "),t("div",{staticClass:"language-console extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('$ curl ${URL}\n{\n  "hostname": "podinfo-6cf9c5fd49-9fzbt",\n  "version": "5.0.2"\n}\n')])])]),t("h2",{attrs:{id:"automated-rollback"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#automated-rollback","aria-hidden":"true"}},[a._v("#")]),a._v(" Automated rollback")]),a._v(" "),t("p",[a._v("During the canary analysis you can generate HTTP 500 errors and high latency\nto test if Flagger pauses and rolls back the faulted version.")]),a._v(" "),t("p",[a._v("Bump podinfo version to "),t("code",[a._v("5.0.3")]),a._v(":")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("yq w -i ./apps/podinfo/kustomization.yaml images"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(".newTag "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5.0")]),a._v(".3\n")])])]),t("p",[a._v("Commit and push changes:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" -A "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" commit -m "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"podinfo 5.0.3"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" push origin main\n")])])]),t("p",[a._v("Tell Flux to pull changes:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("flux reconcile "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("source")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" flux-system\n")])])]),t("p",[a._v("Generate HTTP 500 errors every 30s with curl:")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" -n "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.5")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${URL}")]),a._v("/status/500\n")])])]),t("p",[a._v("When the number of failed checks reaches the canary analysis threshold,\nthe traffic is routed back to the primary and the canary is scaled to zero.")]),a._v(" "),t("div",{staticClass:"language-console extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("$ kubectl -n appmesh-system logs deploy/flagger -f | jq .msg\nAdvance podinfo.apps canary iteration 2/10\nHalt podinfo.apps advancement success rate 98.82% < 99%\nHalt podinfo.apps advancement success rate 97.93% < 99%\nHalt podinfo.apps advancement success rate 97.51% < 99%\nHalt podinfo.apps advancement success rate 98.08% < 99%\nHalt podinfo.apps advancement success rate 96.88% < 99%\nRolling back podinfo.apps failed checks threshold reached 5\nCanary failed! Scaling down podinfo.apps\n")])])]),t("p",[a._v("If you go back to Firefox, you'll see that the podinfo version has been rollback to "),t("code",[a._v("5.0.2")]),a._v(".\nNote that on Chrome or Safari, users haven't been affected by the faulty version,\nas they were not routed to "),t("code",[a._v("5.0.3")]),a._v(" during the analysis.")])])}),[],!1,null,null,null);s.default=n.exports}}]);