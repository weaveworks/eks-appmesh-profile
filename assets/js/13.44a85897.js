(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{370:function(t,a,s){"use strict";s.r(a);var e=s(43),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"canary-tests"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#canary-tests","aria-hidden":"true"}},[t._v("#")]),t._v(" Canary Tests")]),t._v(" "),s("p",[t._v("Flagger comes with a testing service that can run acceptance and load tests when configured as a webhook.")]),t._v(" "),s("h2",{attrs:{id:"define-tests"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#define-tests","aria-hidden":"true"}},[t._v("#")]),t._v(" Define tests")]),t._v(" "),s("p",[t._v("For podinfo, we've setup:")]),t._v(" "),s("ul",[s("li",[t._v("an acceptance test by verifying that the app can issue token")]),t._v(" "),s("li",[t._v("a load test that generates traffic during the canary analysis")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" flagger.app/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Canary\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" podinfo\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("analysis")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("webhooks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" acceptance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pre"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rollout\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//flagger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("loadtester.$(NAMESPACE)/\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 30s\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bash\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cmd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"curl -sd 'test' http://podinfo-canary.$(NAMESPACE):9898/token | grep token\"")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" load"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//flagger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("loadtester.$(NAMESPACE)/\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5s\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cmd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hey -z 1m -q 10 -c 2 http://podinfo-canary.$(NAMESPACE):9898/"')]),t._v("\n")])])]),s("h2",{attrs:{id:"run-tests"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#run-tests","aria-hidden":"true"}},[t._v("#")]),t._v(" Run tests")]),t._v(" "),s("p",[t._v("When the canary analysis starts, Flagger will call the pre-rollout webhooks before routing traffic to the canary.\nIf the acceptance test fails, Flagger will retry until the analysis threshold is reached and the canary is rolled back.")]),t._v(" "),s("p",[t._v("If the acceptance test passes, then Flagger will start the load test and begin the traffic shifting.")]),t._v(" "),s("div",{staticClass:"language-console extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ kubectl -n appmesh-system logs deployment/flagger -f | jq .msg\n\nNew revision detected! Scaling up podinfo.test\nPre-rollout check acceptance-test passed\nAdvance podinfo.test canary weight 5\nAdvance podinfo.test canary weight 10\nAdvance podinfo.test canary weight 15\nAdvance podinfo.test canary weight 20\nAdvance podinfo.test canary weight 25\nAdvance podinfo.test canary weight 30\nAdvance podinfo.test canary weight 35\nAdvance podinfo.test canary weight 40\nAdvance podinfo.test canary weight 45\nAdvance podinfo.test canary weight 50\nCopying podinfo.test template spec to podinfo-primary.test\nRouting all traffic to primary\nPromotion completed! Scaling down podinfo.test\n")])])]),s("h2",{attrs:{id:"manual-gating"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#manual-gating","aria-hidden":"true"}},[t._v("#")]),t._v(" Manual Gating")]),t._v(" "),s("p",[t._v("For manual approval of a canary deployment you can use the "),s("code",[t._v("confirm-rollout")]),t._v(" and "),s("code",[t._v("confirm-promotion")]),t._v(" webhooks.\nThe confirmation rollout hooks are executed before the pre-rollout hooks.\nFlagger will halt the canary traffic shifting and analysis until the confirm webhook returns HTTP status 200.")]),t._v(" "),s("p",[t._v("For manual rollback of a canary deployment you can use the "),s("code",[t._v("rollback")]),t._v(" webhook.  The rollback hook will be called\nduring the analysis and confirmation states.  If a rollback webhook returns a successful HTTP status code, Flagger\nwill shift all traffic back to the primary instance and fail the canary.")]),t._v(" "),s("p",[t._v("Manual gating with Flagger's tester:")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("analysis")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("webhooks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"confirm gate"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" confirm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rollout\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://flagger-loadtester.$(NAMESPACE)/gate/halt"')]),t._v("\n")])])]),s("p",[t._v("The "),s("code",[t._v("/gate/halt")]),t._v(" returns HTTP 403 thus blocking the rollout.")]),t._v(" "),s("p",[t._v("If you have notifications enabled, Flagger will post a message to Slack or MS Teams if a canary rollout is waiting for approval.")]),t._v(" "),s("p",[t._v("Change the URL to "),s("code",[t._v("/gate/approve")]),t._v(" to start the canary analysis:")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("analysis")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("webhooks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"confirm gate"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" confirm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rollout\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://flagger-loadtester.$(NAMESPACE)/gate/approve"')]),t._v("\n")])])]),s("p",[t._v("The "),s("code",[t._v("confirm-promotion")]),t._v(" hook type can be used to manually approve the canary promotion.\nWhile the promotion is paused, Flagger will continue to run the metrics checks and load tests.")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("analysis")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("webhooks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promotion gate"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" confirm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("promotion\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://flagger-loadtester.$(NAMESPACE)/gate/halt"')]),t._v("\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);